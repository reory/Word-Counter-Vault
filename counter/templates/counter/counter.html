{% extends 'counter/base.html' %}

{% block content %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    {% if has_result %}
        <div class="card mb-4 border-primary shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Analysis Result</h4>
                <span class="badge bg-white text-primary fs-6">{{ word_count }} Words</span>
            </div>
            <div class="card-body text-center">
                {% if show_chart %}
                    <button class="btn btn-outline-primary mb-3" data-bs-toggle="collapse" data-bs-target="#chartBox">
                        <i class="bi bi-bar-chart"></i> View Frequency Chart
                    </button>
                    <div id="chartBox" class="collapse">
                        <hr>
                        <img src="{% url 'counter:chart' %}?text={{ text|urlencode }}" alt="Chart" class="img-fluid rounded shadow-sm mt-2 mb-3" />
                    </div>
                {% else %}
                    <div class="alert alert-secondary small mb-0">
                         <i class="bi bi-exclamation-triangle"></i> Text is too large for live charting, but metrics are saved to your Vault!
                    </div>
                {% endif %}
            </div>
        </div>

        {% if vault_pins %}
        <div class="card mb-4 border-info shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-geo-alt-fill"></i> Geographic Word Origins</h5>
            </div>
            <div class="card-body p-0">
                <div id="vault-map" style="height: 400px; width: 100%; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;"></div>
            </div>
        </div>
        {{ vault_pins|json_script:"vault-data" }}
        {% endif %}

        <div class="row mb-4">
            <div class="col-md-6 mb-3 mb-md-0">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="text-primary border-bottom pb-2"><i class="bi bi-journal-text"></i> Summary</h5>
                        <p class="card-text text-secondary mb-3" style="font-size: 0.95rem;">{{ summary }}</p>
                        <h6 class="fw-bold text-dark small">Key Topics:</h6>
                        <p class="analysis-list">
                            {% for topic in topics %}{{ topic }}{% if not forloop.last %}, {% endif %}{% empty %}General content{% endfor %}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="text-primary border-bottom pb-2"><i class="bi bi-lightning-charge"></i> Quality Insights</h5>
                        <ul class="list-unstyled mb-3">
                            <li class="mb-2 small"><strong>Type-Token Ratio:</strong> <span class="text-primary">{{ ttr|floatformat:2 }}</span></li>
                            <li class="mb-2 small"><strong>Passive Voice:</strong> <span class="text-danger">{{ passive_count }}</span></li>
                            <li class="mb-0 small"><strong>Longest Sentence:</strong></li>
                            <li class="text-muted italic small">"{{ longest_sentence|truncatechars:80 }}"</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <div class="card border-primary shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title text-primary m-0"><i class="bi bi-file-earmark-text"></i> New Analysis</h5>
                <button id="themeToggle" class="btn btn-sm btn-primary">
                    <i class="bi bi-moon-stars"></i> Dark Mode
                </button>
            </div>
            <form action="{% url 'counter:home' %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="text1" class="form-label fw-semibold">Paste Text</label>
                    <textarea name="texttocount" id="text1" rows="6" class="form-control" style="background-color: #f0f5f5;" placeholder="Start typing...">{{ text }}</textarea>
                </div>
                <div class="mb-4">
                    <label for="fileInput" class="form-label fw-semibold">Or Upload Document</label>
                    <input type="file" name="file" id="fileInput" class="form-control">
                </div>
                <div class="text-center">
                    <button type="submit" id="runBtn" class="btn btn-primary btn-lg w-50 shadow-sm">Run Counter</button>
                    <div id="filePrompt" class="text-info mt-3 fw-bold" style="display: none;">
                        <i class="bi bi-file-check-fill"></i> File detected! Click "Run Counter" to analyze.
                    </div>
                    {% if has_result %}
                        <div class="mt-4 pt-3 border-top">
                            <a href="{% url 'counter:export_pdf' %}" class="btn btn-sm btn-outline-secondary me-2">PDF</a>
                            <a href="{% url 'counter:export_docx' %}" class="btn btn-sm btn-outline-secondary">DOCX</a>
                        </div>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // 1. VAULT MAP LOGIC
    document.addEventListener('DOMContentLoaded', function() {
        const vaultDataElement = document.getElementById('vault-data');
        if (vaultDataElement) {
            const vaultData = JSON.parse(vaultDataElement.textContent);
            
            // Initialize map
            const map = L.map('vault-map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            if (vaultData.length > 0) {
                const markers = [];
                vaultData.forEach(pin => {
                    const marker = L.marker([pin.lat, pin.lng]).addTo(map);
                    marker.bindPopup(`
                        <strong>${pin.word.toUpperCase()}</strong><br>
                        <small>Origin: ${pin.country} (${pin.root})</small><br>
                        <p style="margin-top:5px; font-size:12px;">${pin.fact}</p>
                    `);
                    markers.push(marker);
                });
                
                // Zoom to fit markers
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.2));
            }
        }
    });

    // 2. EXISTING FILE INPUT LOGIC
    const fileInput = document.getElementById('fileInput');
    const filePrompt = document.getElementById('filePrompt');
    const runBtn = document.getElementById('runBtn');

    if(fileInput) {
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                filePrompt.style.display = 'block';
                runBtn.classList.replace('btn-primary', 'btn-info');
            } else {
                filePrompt.style.display = 'none';
                runBtn.classList.replace('btn-info', 'btn-primary');
            }
        });
    }
</script>
{% endblock %}